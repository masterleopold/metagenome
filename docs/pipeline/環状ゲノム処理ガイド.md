# MinIONパイプライン用環状ゲノム処理ガイド

**文書種別**: バイオインフォマティクスパイプライン文書
**バージョン**: 1.0
**日付**: 2025年11月13日
**関連**: プロトコル12 v2.1、Step 2.5

---

## 概要

本文書は、MinION病原体検出パイプラインが**環状DNAゲノム**および**1本鎖DNA（ssDNA）ゲノム**をどのように処理するかを説明します。これらはシーケンシング前の特別な前処理と、バイオインフォマティクス解析中の特別な考慮事項を必要とします。

### 影響を受ける病原体（91 PMDA病原体のうち4種）

| 病原体コード | 正式名称 | ゲノム構造 | サイズ | PMDA分類 | 特別処理 |
|---------------|-----------|------------------|------|---------------------|------------------|
| **PCV2** | Porcine Circovirus 2 | 環状ssDNA | 1.7 kb | 特別管理病原体 #3 | 直鎖化 + 合成 |
| **PCV3** | Porcine Circovirus 3 | 環状ssDNA | 2.0 kb | 特別管理病原体 #3 | 直鎖化 + 合成 |
| **TTV** | Torque Teno Virus | 環状ssDNA | 3.8 kb | 標準 #40 | 直鎖化 + 合成 |
| **PPV** | Porcine Parvovirus | 直鎖ssDNA | 5.0 kb | 標準 #1 | 合成のみ |

---

## 実験室処理（プロトコル12 v2.1 Step 2.5）

### 特別処理が必要な理由

**問題1: 環状DNAは直接シーケンス不可能**
- Oxford Nanopore SQK-LSK114ライゲーションキットはアダプター結合に**遊離DNA末端**を必要とする
- 環状DNAには3'/5'末端がない → アダプターライゲーション不可 → シーケンシング不可
- 解決策: **DNase I直鎖化**でランダムなニックを作り、環状→直鎖に変換

**問題2: ssDNAはライゲーション効率が低い**
- T4 DNAリガーゼ（LSK114使用）は1本鎖DNAで**<5%効率**
- MinIONモータータンパク質は**dsDNA入力**を必要とする（dsDNAをほどいて→ssDNAをシーケンシング）
- 解決策: **Klenow Fragment 2本鎖合成**でssDNA → dsDNAに変換

### Step 2.5処理（2.5時間）

**Sub-step 2.5.1: 環状DNA直鎖化**（30分）
```
環状DNA + DNase I（0.005 U）→ 37°C、5分 → 遊離末端を持つ直鎖DNA
```

**Sub-step 2.5.2: ssDNA → dsDNA変換**（2時間）
```
ssDNA + ランダムヘキサマー → 25°C、5分（アニーリング）
      + Klenow Fragment → 16°C、60分（合成）
      → LSK114対応dsDNA
```

---

## バイオインフォマティクス解析の考慮事項

### 1. 環状ゲノムへのリードマッピング

#### 問題: 環状ゲノム「接合部」リード

環状DNAがランダムに直鎖化されると、一部のシーケンシングリードは**環状化接合部**（元の環状ゲノムで5'末端と3'末端が結合していた点）をまたぐ可能性があります。

**例: PCV2（1768 bp環状ゲノム）**
```
元の環状ゲノム:
   位置1 ────────────────── 位置1768
        ↑                          ↓
        └──────────────────────────┘
              （環状に接続）

位置500でのDNase I直鎖化後:
   位置500 ──────────────────────→ 位置1768 → 位置1 ──────→ 位置499
   （現在遊離5'末端）                              （現在遊離3'末端）

元の1768→1接続をまたぐ接合部リード:
   リード: ...ATCG [位置1760-1768] [位置1-20] GATC...
          └─── ゲノム末端 ───┘ └── ゲノム開始 ──┘
```

#### 解決策1: 参照ゲノムの重複（推奨）

**Minimap2アラインメント用**、重複参照を作成:
```bash
# 元の環状参照（1768 bp）
>PCV2_circular
ATCGATCGATCG...(1768 bp)

# 重複参照（3536 bp = 1768 × 2）
>PCV2_linearized_duplicated
ATCGATCGATCG...(1768 bp)...ATCGATCGATCG...(1768 bp繰り返し)
```

**利点**:
- 接合部リードが分割アラインメントなしで連続的にマップ
- アラインメントパイプラインで特別な処理不要
- 標準的なカバレッジ計算が正しく機能

**実装**:
```python
# scripts/database_preparation/duplicate_circular_genomes.py

def duplicate_circular_reference(seq: str, genome_name: str) -> str:
    """
    接合部リードの適切なマッピングのために環状ゲノム配列を重複。

    Args:
        seq: 元の環状ゲノム配列
        genome_name: ゲノム識別子

    Returns:
        重複配列のFASTAエントリ
    """
    duplicated_seq = seq + seq
    return f">{genome_name}_linearized_dup\n{duplicated_seq}\n"

# PCV2の使用例
circular_genomes = {
    'PCV2': 'ATCGATCG...',  # 1768 bp
    'PCV3': 'GCTAGCTA...',  # 2000 bp
    'TTV': 'TTAATTAA...',   # 3800 bp
}

for name, seq in circular_genomes.items():
    duplicate_circular_reference(seq, name)
```

**カバレッジ計算調整**:
```python
def calculate_circular_genome_coverage(bam_file, genome_length):
    """
    重複参照を持つ環状ゲノムのカバレッジ計算。

    重複参照の前半のみカウント
    （位置0からgenome_length-1まで）。
    """
    coverage = []
    for pileup in bam_file.pileup():
        position = pileup.pos
        if position < genome_length:  # 前半のみ
            coverage.append(pileup.n)
        # 後半は無視（位置 >= genome_length）

    mean_coverage = sum(coverage) / len(coverage) if coverage else 0
    return mean_coverage
```

---

### 2. コピー数定量

#### ゲノムサイズの考慮事項

**重要**: 環状ゲノムには、重複参照サイズではなく**実際の環状ゲノムサイズ**を使用します。

```python
# scripts/phase5_quantification/absolute_copy_number.pyから

GENOME_SIZES = {
    # 重複サイズではなく、実際の環状ゲノムサイズを使用
    'PCV2': 1768,       # 3536（重複）ではない
    'PCV3': 2000,       # 4000（重複）ではない
    'TTV': 3800,        # 7600（重複）ではない
    'PPV': 5000,        # 直鎖ssDNA、重複なし
}
```

**根拠**: 1つの環状ゲノム分子は1768 bpのユニーク配列を持ちます。3536 bp重複参照にマップしても同じです。コピー数計算は実際のゲノムサイズを使用する必要があります。

---

### 3. カバレッジ解析

#### 完全ゲノムカバレッジの検出

環状ゲノムの場合、**環状配列全体**にわたってカバレッジが広がることを確認:

```python
def check_circular_genome_coverage(bam_file, genome_name, genome_length, min_coverage=5):
    """
    環状ゲノムが完全なカバレッジを持つか確認。

    Args:
        bam_file: アラインメント付きBAMファイル
        genome_name: 環状ゲノム参照名
        genome_length: 環状ゲノム長（例: PCV2で1768）
        min_coverage: 「カバーされた」と見なす最小深度（デフォルト: 5×）

    Returns:
        カバレッジ統計の辞書
    """
    import pysam

    bam = pysam.AlignmentFile(bam_file, "rb")

    # 各位置のカバレッジ取得（重複の場合は前半のみ）
    coverage = [0] * genome_length
    for pileup in bam.pileup(genome_name):
        pos = pileup.pos
        if pos < genome_length:  # 前半のみカウント
            coverage[pos] = pileup.n

    # 統計計算
    covered_positions = sum(1 for depth in coverage if depth >= min_coverage)
    mean_depth = sum(coverage) / len(coverage) if coverage else 0
    genome_coverage_pct = (covered_positions / genome_length) * 100

    # ギャップ確認（カバーされていない領域）
    gaps = []
    in_gap = False
    gap_start = 0
    for i, depth in enumerate(coverage):
        if depth < min_coverage and not in_gap:
            in_gap = True
            gap_start = i
        elif depth >= min_coverage and in_gap:
            in_gap = False
            gaps.append((gap_start, i-1))

    return {
        'genome': genome_name,
        'length': genome_length,
        'mean_depth': round(mean_depth, 2),
        'coverage_pct': round(genome_coverage_pct, 2),
        'covered_positions': covered_positions,
        'uncovered_positions': genome_length - covered_positions,
        'gaps': gaps,
        'complete_coverage': genome_coverage_pct > 95.0
    }
```

---

### 4. バリアント検出の考慮事項

#### 環状ゲノム座標系

環状ゲノムでバリアントを検出する場合:

**問題**: 位置1のバリアントは、実際には「人工的な」直鎖化点の近くにある可能性があります。

**解決策**: 環状ゲノム座標でバリアントを報告:

```python
def adjust_variant_position_for_circular(variant_pos, genome_length, linearization_point=0):
    """
    環状ゲノム座標系へのバリアント位置調整。

    Args:
        variant_pos: 直鎖化参照での位置
        genome_length: 環状ゲノム長
        linearization_point: 環状が直鎖化された位置（デフォルト: 0）

    Returns:
        環状座標系での位置
    """
    # 重複参照を使用する場合、genome_lengthで剰余を取る
    circular_pos = (variant_pos - linearization_point) % genome_length
    return circular_pos

# 例:
# PCV2を位置500で直鎖化、位置1900でバリアント検出
variant_pos_linear = 1900
genome_length = 1768
linearization_point = 500

circular_pos = adjust_variant_position_for_circular(variant_pos_linear, genome_length, linearization_point)
# 結果: circular_pos = 632（元の環状座標で）
```

---

## データベース準備

### 参照配列準備

**ステップ1: 参照配列取得**

```bash
# PCV2（GenBank: AF027217.1）
# PCV3（GenBank: MF318988.1）
# TTV（GenBank: AB017610.1）
# PPV（GenBank: NC_001718.1）

# NCBIからダウンロード
wget "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id=AF027217.1&rettype=fasta" -O PCV2.fasta
wget "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id=MF318988.1&rettype=fasta" -O PCV3.fasta
wget "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id=AB017610.1&rettype=fasta" -O TTV.fasta
wget "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id=NC_001718.1&rettype=fasta" -O PPV.fasta
```

**ステップ2: 環状ゲノム参照の重複**

```bash
# PCV2、PCV3、TTV（環状ゲノム）を重複
python scripts/database_preparation/duplicate_circular_genomes.py \
    --input PCV2.fasta,PCV3.fasta,TTV.fasta \
    --output circular_genomes_duplicated.fasta

# PPV（直鎖ssDNA）は重複不要
cat PPV.fasta >> linear_genomes.fasta
```

**ステップ3: Minimap2インデックス構築**

```bash
# すべての参照を結合
cat circular_genomes_duplicated.fasta linear_genomes.fasta other_pmda_genomes.fasta > pmda_all_91.fasta

# Minimap2インデックス構築
minimap2 -d pmda_all_91.mmi pmda_all_91.fasta
```

---

## 品質管理チェック

### QCチェックポイント1: Step 2.5後の検証

**目的**: 直鎖化とssDNA→dsDNA変換が成功したことを確認

**メトリック**:
- ✅ 直鎖化後のQubit回収 >70%
- ✅ 2本鎖合成後のQubit回収 >80%
- ✅ Bioanalyzer濃度 ≈ Qubitの2倍（dsDNAを示す）

**QC失敗の場合**: 環状/ssDNAウイルスの検出率 <5%

---

### QCチェックポイント2: シーケンシング後の検証

**目的**: 環状ゲノムが適切に検出されたことを確認

**PCV2/PCV3/TTVのメトリック**:
- ✅ ゲノム全体で平均カバレッジ >10×（大きなギャップなし）
- ✅ カバレッジ均一性（SD/平均 <0.5）
- ✅ 接合部リード存在（重複参照使用の場合、両半分にマップするリード）

**トラブルシューティング**:
| 問題 | 原因 | 解決策 |
|-------|-------|----------|
| リードマッピングなし | Step 2.5失敗 | 新鮮な試薬でStep 2.5を繰り返す |
| 低カバレッジ（<5×） | 直鎖化不完全 | DNase I濃度を最適化 |
| カバレッジに大きなギャップ | 過消化 | DNase Iを0.003 Uに減らす |
| 接合部リードなし | 参照が重複されていない | 重複参照を使用 |

---

## 実装チェックリスト

**データベース準備**:
- ☐ PCV2、PCV3、TTV、PPV参照配列をダウンロード
- ☐ 環状ゲノム参照を重複（PCV2、PCV3、TTV）
- ☐ 重複参照でMinimap2インデックスを構築
- ☐ 正しいゲノムサイズでabsolute_copy_number.pyを更新

**パイプラインスクリプト**:
- ☐ 環状ゲノムを処理するようdetect_pmda_all_91_pathogens.pyを更新
- ☐ 重複参照用のカバレッジ計算スクリプトを更新
- ☐ 定量スクリプトにTTVを追加
- ☐ 合成環状ssDNAサンプルでテスト

**品質管理**:
- ☐ Step 2.5 QCチェックポイントを検証
- ☐ 環状ゲノムカバレッジ解析を検証
- ☐ 接合部リードマッピングを確認
- ☐ 500 copies/mLでPCV2/PCV3検出をテスト

**文書化**:
- ☐ この文書完了
- ☐ Step 2.5でプロトコル12 v2.1を更新
- ☐ 環状ゲノム処理についてスタッフをトレーニング
- ☐ PCV2/PCV3/TTV/PPVのLOD検証完了

---

## 参考文献

### 技術文献
1. Li H. Minimap2: pairwise alignment for nucleotide sequences. Bioinformatics. 2018;34:3094-3100.
2. Salzberg SL, Yorke JA. Beware of mis-assembled genomes. Bioinformatics. 2005;21:4320-4321.
3. Wylie TN, et al. Enhanced virome sequencing using targeted sequence capture. Genome Research. 2015;25:1910-1920.

### 環状ゲノムバイオインフォマティクス
4. Wick RR, et al. Completing bacterial genome assemblies with multiplex MinION sequencing. Microb Genom. 2017;3:e000132.
5. Hunt M, et al. Circlator: automated circularization of genome assemblies using long sequencing reads. Genome Biol. 2015;16:294.

### 病原体固有
6. Johne R, et al. Detection and sequence analysis of porcine circovirus 2 in Germany. Arch Virol. 2004;149:2001-2010.
7. Phan TG, et al. The fecal viral flora of wild rodents. PLoS Pathog. 2011;7:e1002218.

### Oxford Nanopore
8. Oxford Nanopore Technologies. Ligation Sequencing Kit SQK-LSK114 Protocol. 2024.
9. Oxford Nanopore Technologies. Circular consensus sequencing for improved accuracy. Technical Note. 2023.

---

## 文書管理

**バージョン**: 1.0
**日付**: 2025年11月13日
**著者**: MinIONパイプライン開発チーム
**関連文書**:
- プロトコル12 v2.1（Step 2.5）
- absolute_copy_number.py（v2.1）
- detect_pmda_all_91_pathogens.py
**次回レビュー**: 2026年5月13日（6ヶ月後）

---

**環状ゲノム処理ガイド終了**
